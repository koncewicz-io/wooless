!function(){"use strict";class e{constructor(){this.reset(),this.debug=!1,this.regulation=!1,this.checkout="block"}setError(e){this.error=!0,this.errorMessage=e,this.debug&&console.log("Error:",e)}setCheckout(e){this.checkout=e}hasError(){return this.error}getError(){return this.errorMessage}reset(){this.error=!1,this.errorMessage=null}setRegulation(e){this.regulation=!!e}}const t=async(e,t,i=(()=>{}),s=!1)=>{let r=document.getElementById(e);if(r&&s&&(r.remove(),r=!1),!r){const s=document.createElement("script");return s.src=t,s.id=e,document.head.appendChild(s),await new Promise((e=>{s.addEventListener("load",(()=>e(i())))}))}return i(),!0};class i{constructor(e){const{mode:t="sandbox",debug:i=!1}=e;this.iframeContainer="card-whitelabel",this.debug=i,this.mode=t,this.promise={reject:()=>{},resolve:()=>{},redirect:""}}init(){document.addEventListener("Przelewy24CardWhileLabelHandlerReady",(()=>this.whiteLabelHandler()),{once:!0})}getWhiteLabelElement(){return document.getElementById(this.iframeContainer)}resetWhiteLabelIframe(){const e=this.getWhiteLabelElement();e&&(e.innerHTML="")}onNeedInteraction(){}onNoNeedInteraction(){const{redirect:e,resolve:t}=this.promise;t({success:!0,redirect:e})}onFailed(e){const{resolve:t}=this.promise;t({error:e?.message||"Something goes wrong"})}onSuccess(){}whiteLabelHandler(){this.debug&&console.log("Run whitelabel event handler"),Przelewy24CardWhileLabelHandler.config({P24TargetElementId:this.iframeContainer,P24CardWhiteLabelStartEventCallback:e=>{this.debug&&(console.log("Start on merchant site"),console.log(e))},P24NeedInteractionEventCallback:e=>{this.debug&&(console.log("Need interaction on merchant site"),console.log(e)),this.onNeedInteraction(e)},P24DontNeedInteractionEventCallback:e=>{this.debug&&(console.log("Don't need interaction on merchant site"),console.log(e)),this.onNoNeedInteraction(e)},P24ScriptFailedEventCallback:e=>{this.debug&&(console.log("Fail!"),console.log(e)),this.onFailed(e)},P24ScriptSuccessfulEndsEventCallback:e=>{this.debug&&(console.log("Success!"),console.log(e)),this.onSuccess(e)}}),Przelewy24CardWhileLabelHandler.main()}runObserver(){const e=this.getWhiteLabelElement();if(!e)return;new MutationObserver(((t,i)=>{for(const i of t)if("childList"===i.type){const t=e.querySelector("iframe");t&&(window.location=t.src)}})).observe(e,{childList:!0})}getIframeUrl(){const e=this.getWhiteLabelElement().querySelector("iframe");return e?.src||null}async load(e){this.resetWhiteLabelIframe(),await t("card-whitelabel-script",`https://${this.mode}.przelewy24.pl/whitelabel/card/javascript/${e}`,(()=>{}),!0)}async onResponse(e){return new Promise(((t,i)=>{const{error:s,token:r,redirect:n}=e;this.promise.resolve=t,this.promise.reject=i,this.promise.redirect=n,s?t({error:s}):r&&(this.debug&&console.log("Transaction token",r),this.load(r))}))}}class s extends e{constructor(e){super();const{config:t,mode:s="sandbox",lang:r="pl",clickToPay:n,recurring:o=!1,debug:c=!1}=e,{merchant_id:a,session_id:l,signature:h,options:d}=t;this.debug=c,this.tokenizerElement="card-tokenizer",this.merchantId=a,this.sessionId=l,this.signature=h,this.recurring=o,this.mode=s,this.clickToPay=n,this.whiteLabel=new i(e),this.tokenizer=null,this.error=null,this.cardData=null,this.oneClick=!1,this.saveOneClick=!1,this.prepareOptions(d,r)}prepareOptions(e,t){if("string"==typeof e)try{this.options=JSON.parse(e)}catch(e){this.options={}}else this.options=e;this.options.lang=t,this.options.c2p=!1,this.options?.agreement?this.options.agreement.TOSLanguage=t:this.agreement={contentEnabled:{enabled:!1,checkboxEnabled:!1},TOSLanguage:t},this.clickToPay?.enabled&&(this.options.c2p=!0,this.clickToPay?.email&&this.setClickToPayEmail(this.clickToPay.email))}setClickToPayEmail(e){this.options.c2p&&(this.options.psu={email:e})}setRecurring(e){this.recurring=e}setSaveOneClick(e){this.saveOneClick=e}setOneClick(e){this.oneClick=e||!1}async prepareData(){return this.error=null,this.cardData=null,!!this.oneClick||await this.tokenize()}async tokenize(){const e=this.saveOneClick||this.recurring?"permanent":"temporary";this.debug&&console.log("Tokenize mode",e);const t=await this.tokenizer.tokenize(e),{errors:i=[],data:s}=t?.data||{};if(i.length){const[e]=i;this.error=e}else s&&(this.cardData=s);return!!s}getError(){return this.error}loadTokenizer(){t("card-tokenizer-script",`https://${this.mode}.przelewy24.pl/js/cardTokenizationIframe.min.js`,(()=>this.onLoadTokenizer()))}onLoadTokenizer(){this.tokenizer=new Przelewy24CardTokenization(this.merchantId,this.sessionId,this.signature),this.renderTokenizer()}renderTokenizer(){this.tokenizer.render("form",`#${this.tokenizerElement}`,this.options)}reRenderTokenizer(){document.getElementById(this.tokenizerElement).innerHTML="",this.loadTokenizer(),this.whiteLabel.init(),this.whiteLabel.runObserver()}getPaymentData(){let e="card-data";return this.oneClick&&(e="one-click"),{type:e,regulation:this.regulation,checkout:this.checkout,...Object.entries(this.cardData||{}).reduce(((e,[t,i])=>({...e,[t]:""+(i||"")})),{}),oneClick:!!this.oneClick&&this.oneClick.toString(),save:this.saveOneClick}}}class r{constructor(e){this.parent=e,this.notice=document.createElement("div"),this.notice.classList.add("wc-block-components-notice-banner"),this.notice.classList.add("is-error")}show(e){e&&(e="object"==typeof e?e?.message:e,this.notice.innerHTML=e,this.parent.prepend(this.notice))}hide(){this.notice.remove()}}class n{constructor(){this.selectors={form:document.querySelector("form.p24-payment-container"),submitButton:document.getElementById("submit"),regulation:document.getElementById("regulation")},this.config=window._config,this.service=null,this.notice=new r(this.selectors.form),this.submitHandler(),this.regulationHandlers()}regulationHandlers(){const{regulation:e}=this.selectors;e&&e.addEventListener("change",(()=>{this.service.setRegulation(e.checked)}))}submitHandler(){const{form:e}=this.selectors;e.addEventListener("submit",(e=>{e.preventDefault(),this.notice.hide(),this.submit()}))}async submit(){}async submitData(){const e={type:"register-transaction",orderId:this.config.orderId,orderKey:this.config.orderKey,checkout:this.service.checkout,paymentDetails:this.service.getPaymentData()};let t=await fetch(this.config.url,{method:"POST",body:JSON.stringify(e)});const{data:i}=await t.json()||{data:{}};return i}}class o extends n{constructor(){super(),this.selectors={...this.selectors,saveOneClick:document.getElementById("save-one-click"),oneClickItems:document.querySelectorAll(".woocommerce-order-pay .p24-1click")},this.oneClickHandlers()}oneClickHandlers(){const{saveOneClick:e,oneClickItems:t}=this.selectors;e&&e.addEventListener("change",(()=>{this.service.setSaveOneClick(e.checked)})),t.length&&t.forEach((i=>i.addEventListener("click",(()=>{const{id:s}=i.dataset,{oneClick:r}=this.service;t.forEach((e=>e.classList.remove("p24-1click--active"))),console.log(r,s),r===s?(this.service.setOneClick(!1),this.service.setSaveOneClick(!1),e.checked=!1):(i.classList.add("p24-1click--active"),this.service.setOneClick(s))}))))}}class c extends o{constructor(){super(),this.service=new s(_config),this.service.setCheckout("legacy"),this.service.loadTokenizer(),this.service.whiteLabel.init(),this.service.whiteLabel.runObserver()}async submit(){const{submitButton:e}=this.selectors;e.disabled=!0;try{if(await this.service.prepareData(),this.service.hasError())throw new Error(this.service.getError());const{success:e,error:t,token:i}=await this.submitData();if(t)throw new Error(t);e&&i&&await this.service.whiteLabel.load(i)}catch(e){this.notice.show(e)}e.disabled=!1}}window.addEventListener("DOMContentLoaded",(()=>{window.p24CardReceipt=new c}))}();
