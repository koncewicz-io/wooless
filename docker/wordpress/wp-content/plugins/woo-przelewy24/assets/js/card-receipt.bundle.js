!function(){"use strict";class e{constructor(){this.reset(),this.debug=!1,this.regulation=!1,this.checkout="block"}setError(e){this.error=!0,this.errorMessage=e,this.debug&&console.log("Error:",e)}setCheckout(e){this.checkout=e}hasError(){return this.error}getError(){return this.errorMessage}reset(){this.error=!1,this.errorMessage=null}setRegulation(e){this.regulation=!!e}}const t=async(e,t,i=()=>{},s=!1)=>{let r=document.getElementById(e);if(r&&s&&(r.remove(),r=!1),!r){const s=document.createElement("script");return s.src=t,s.id=e,document.head.appendChild(s),await new Promise((e=>{s.addEventListener("load",(()=>e(i())))}))}return i(),!0};class i{constructor(e){const{mode:t="sandbox",debug:i=!1}=e;this.iframeContainer="p24-3ds-iframe-wrapper",this.modalId="p24-3ds-modal",this.debug=i,this.mode=t,this.promise={reject:()=>{},resolve:()=>{},redirect:""}}init(){document.addEventListener("Przelewy24CardWhileLabelHandlerReady",(()=>this.whiteLabelHandler()),{once:!0})}getIframeWrapper(){return document.getElementById(this.iframeContainer)}getModal(){return document.getElementById(this.modalId)}openModal(){const e=this.getModal();e&&e.classList.add("active")}closeModal(){const e=this.getModal();e&&e.classList.remove("active")}resetWhiteLabelIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}onNeedInteraction(){this.debug&&console.log("[P24] Need interaction — showing modal"),this.openModal()}onNoNeedInteraction(){this.debug&&console.log("[P24] No interaction — handled by runObserver")}onFailed(e){this.debug&&console.log("[P24] Payment failed"),this.removeIframe(),this.closeModal();const{resolve:t}=this.promise;t({error:e?.message||"Something goes wrong"})}onSuccess(){this.closeModal(),this.removeIframe(),this.promise?.redirect?window.location.href=this.promise.redirect:console.warn("[P24] No redirect URL available")}removeIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}whiteLabelHandler(){Przelewy24CardWhileLabelHandler.config({P24TargetElementId:this.iframeContainer,P24CardWhiteLabelStartEventCallback:()=>{},P24NeedInteractionEventCallback:e=>{this.debug&&console.log("Need interaction:",e),this.onNeedInteraction(e)},P24DontNeedInteractionEventCallback:e=>{this.debug&&console.log("No interaction needed:",e),this.onNoNeedInteraction(e)},P24ScriptFailedEventCallback:e=>{this.debug&&console.log("Fail:",e),this.onFailed(e)},P24ScriptSuccessfulEndsEventCallback:e=>{this.debug&&console.log("Success:",e),this.onSuccess(e)}}),Przelewy24CardWhileLabelHandler.main(),this.runObserver()}runObserver(){const e=this.getIframeWrapper();if(!e)return;new MutationObserver((t=>{t.forEach((t=>{e.querySelector("iframe")}))})).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src"]})}async load(e){this.resetWhiteLabelIframe(),await t("card-whitelabel-script",`https://${this.mode}.przelewy24.pl/whitelabel/card/javascript/${e}`,(()=>{}),!0)}async onResponse(e){return console.log("[P24] onResponse input",e),new Promise(((t,i)=>{const{error:s,token:r,redirect:o}=e;this.promise.resolve=t,this.promise.reject=i,this.promise.redirect=o,s?t({error:s}):r&&(this.debug&&console.log("[P24] Transaction token:",r),this.load(r),o&&console.log("[P24] Redirect fallback:",o))}))}}class s extends e{constructor(e){super();const{config:t,mode:s="sandbox",lang:r="pl",clickToPay:o,recurring:n=!1,debug:a=!1}=e,{merchant_id:c,session_id:l,signature:h,options:d}=t;this.debug=a,this.tokenizerElement="card-tokenizer",this.merchantId=c,this.sessionId=l,this.signature=h,this.recurring=n,this.mode=s,this.clickToPay=o,this.whiteLabel=new i({...e}),this.tokenizer=null,this.error=null,this.cardData=null,this.oneClick=!1,this.saveOneClick=!1,this.prepareOptions(d,r)}prepareOptions(e,t){if("string"==typeof e)try{this.options=JSON.parse(e)}catch(e){this.options={}}else this.options=e;this.options.lang=t,this.options.loader=!0,this.options.errorMessage=!1,this.options.c2p=!1,this.options?.agreement||(this.agreement={contentEnabled:{enabled:!1,checkboxEnabled:!1}}),this.clickToPay?.enabled&&(this.options.c2p=!0,this.clickToPay?.email&&this.setClickToPayEmail(this.clickToPay.email))}setClickToPayEmail(e){this.options.c2p&&(this.options.psu={email:e})}setRecurring(e){this.recurring=e}setSaveOneClick(e){this.saveOneClick=e}setOneClick(e){this.oneClick=e||!1}async prepareData(){return this.error=null,this.cardData=null,!!this.oneClick||await this.tokenize()}async tokenize(){const e=this.saveOneClick||this.recurring?"permanent":"temporary";this.debug&&console.log("Tokenize mode",e);const t=await this.tokenizer.tokenize(e),{errors:i=[],data:s}=t?.data||{};if(i.length){const[e]=i;this.error=e}else s&&(this.cardData=s);return!!s}getError(){return this.error}loadTokenizer(){t("card-tokenizer-script",`https://${this.mode}.przelewy24.pl/js/cardTokenizationIframe.min.js?cms=woo&mid=${this.merchantId}&oc=${this.oneClick}&c2p=${this.options.c2p}`,(()=>this.onLoadTokenizer()))}onLoadTokenizer(){this.tokenizer=new Przelewy24CardTokenization(this.merchantId,this.sessionId,this.signature),this.renderTokenizer()}renderTokenizer(){this.tokenizer.render("form",`#${this.tokenizerElement}`,this.options)}reRenderTokenizer(){document.getElementById(this.tokenizerElement).innerHTML="",window.Przelewy24CardTokenization?this.onLoadTokenizer():this.loadTokenizer(),this.whiteLabel.init(),this.whiteLabel.runObserver()}getPaymentData(){let e="card-data";return this.oneClick&&(e="one-click"),{type:e,regulation:this.regulation,checkout:this.checkout,...Object.entries(this.cardData||{}).reduce(((e,[t,i])=>({...e,[t]:""+(i||"")})),{}),oneClick:!!this.oneClick&&this.oneClick.toString(),save:this.saveOneClick}}}class r{constructor(e){this.parent=e,this.notice=document.createElement("div"),this.notice.classList.add("wc-block-components-notice-banner"),this.notice.classList.add("is-error")}show(e){e&&(e="object"==typeof e?e?.message:e,this.notice.innerHTML=e,this.parent.prepend(this.notice))}hide(){this.notice.remove()}}class o{constructor(){this.selectors={form:document.querySelector("form.p24-payment-container"),submitButton:document.getElementById("submit"),regulation:document.getElementById("regulation")},this.config=window._config,this.service=null,this.notice=new r(this.selectors.form),this.submitHandler(),this.regulationHandlers()}regulationHandlers(){const{regulation:e}=this.selectors;e&&e.addEventListener("change",(()=>{this.service.setRegulation(e.checked)}))}submitHandler(){const{form:e}=this.selectors;e.addEventListener("submit",(e=>{e.preventDefault(),this.notice.hide(),this.submit()}))}async submit(){}async submitData(){const e={type:"register-transaction",orderId:this.config.orderId,orderKey:this.config.orderKey,checkout:this.service.checkout,paymentDetails:this.service.getPaymentData()};let t=await fetch(this.config.url,{method:"POST",body:JSON.stringify(e)});const{data:i}=await t.json()||{data:{}};return i}}class n extends o{constructor(){super(),this.selectors={...this.selectors,saveOneClick:document.getElementById("save-one-click"),oneClickItems:document.querySelectorAll(".woocommerce-order-pay .p24-1click")},this.oneClickHandlers()}oneClickHandlers(){const{saveOneClick:e,oneClickItems:t}=this.selectors;e&&e.addEventListener("change",(()=>{this.service.setSaveOneClick(e.checked)})),t.length&&t.forEach((i=>i.addEventListener("click",(()=>{const{id:s}=i.dataset,{oneClick:r}=this.service;t.forEach((e=>e.classList.remove("p24-1click--active"))),console.log(r,s),r===s?(this.service.setOneClick(!1),this.service.setSaveOneClick(!1),e.checked=!1):(i.classList.add("p24-1click--active"),this.service.setOneClick(s))}))))}}class a extends n{constructor(){super(),this.service=new s(_config),this.service.setCheckout("legacy"),this.service.loadTokenizer(),this.service.whiteLabel.init(),this.service.whiteLabel.runObserver()}async submit(){const{submitButton:e}=this.selectors;e.disabled=!0;try{if(await this.service.prepareData(),this.service.hasError())throw new Error(this.service.getError());const e=await this.submitData();if(e.error)throw new Error(e.error);await this.service.whiteLabel.onResponse(e)}catch(e){this.notice.show(e)}e.disabled=!1}}window.addEventListener("DOMContentLoaded",(()=>{window.p24CardReceipt=new a}))}();
