(()=>{"use strict";const e=window.wp.htmlEntities,t=window.React,s=window.wp.i18n,i=window.ReactJSXRuntime,{CheckboxControl:r}=window.wc.blocksCheckout,n=t=>{const{description:s}=t;return(0,e.decodeEntities)(s||"")},o=e=>{let{src:t,name:s=""}=e.icon;return"string"==typeof e.icon&&(t=e.icon),(0,i.jsx)("img",{style:{maxHeight:"20px"},src:t,title:s,alt:s,loading:"lazy"})},a=e=>{const{icons:t,additional:r}=e;return t.length?(0,i.jsxs)("span",{style:{display:"flex",flexWrap:"wrap",gap:"6px",fontSize:"65%",alignItems:"center",justifyContent:"flex-end"},children:[t.map((({src:e,name:t},s)=>(0,i.jsx)(o,{icon:{src:e,name:t}},s))),r?(0,i.jsx)("span",{style:{lineHeight:"1.2"},children:(0,s.sprintf)((0,s.__)("+%d other methods","woocommerce-p24"),r)}):""]}):""},l=({required:e=!1,label:t,checked:s,onChange:n,...o})=>(0,i.jsx)(r,{required:e,label:(0,i.jsx)("span",{dangerouslySetInnerHTML:{__html:t}}),checked:s,onChange:n,...o,__nextHasNoMarginBottom:!0}),c=e=>{const{PaymentMethodLabel:t}=e.components,{label:s,icon:r,icons:n,additional:l}=e;return(0,i.jsxs)("span",{style:{width:"100%",display:"flex",gap:"12px",justifyContent:"space-between",alignItems:"center"},children:[(0,i.jsx)(t,{text:s}),n?(0,i.jsx)(a,{icons:n,additional:l}):"",r?(0,i.jsx)(o,{icon:r}):""]})};class d{constructor(){this.reset(),this.debug=!1,this.regulation=!1,this.checkout="block"}setError(e){this.error=!0,this.errorMessage=e,this.debug&&console.log("Error:",e)}setCheckout(e){this.checkout=e}hasError(){return this.error}getError(){return this.errorMessage}reset(){this.error=!1,this.errorMessage=null}setRegulation(e){this.regulation=!!e}}const h=async(e,t,s=()=>{},i=!1)=>{let r=document.getElementById(e);if(r&&i&&(r.remove(),r=!1),!r){const i=document.createElement("script");return i.src=t,i.id=e,document.head.appendChild(i),await new Promise((e=>{i.addEventListener("load",(()=>e(s())))}))}return s(),!0},p=class{constructor(e){const{mode:t="sandbox",debug:s=!1}=e;this.iframeContainer="p24-3ds-iframe-wrapper",this.modalId="p24-3ds-modal",this.debug=s,this.mode=t,this.promise={reject:()=>{},resolve:()=>{},redirect:""}}init(){document.addEventListener("Przelewy24CardWhileLabelHandlerReady",(()=>this.whiteLabelHandler()),{once:!0})}getIframeWrapper(){return document.getElementById(this.iframeContainer)}getModal(){return document.getElementById(this.modalId)}openModal(){const e=this.getModal();e&&e.classList.add("active")}closeModal(){const e=this.getModal();e&&e.classList.remove("active")}resetWhiteLabelIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}onNeedInteraction(){this.debug&&console.log("[P24] Need interaction — showing modal"),this.openModal()}onNoNeedInteraction(){this.debug&&console.log("[P24] No interaction — handled by runObserver")}onFailed(e){this.debug&&console.log("[P24] Payment failed"),this.removeIframe(),this.closeModal();const{resolve:t}=this.promise;t({error:e?.message||"Something goes wrong"})}onSuccess(){this.closeModal(),this.removeIframe(),this.promise?.redirect?window.location.href=this.promise.redirect:console.warn("[P24] No redirect URL available")}removeIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}whiteLabelHandler(){Przelewy24CardWhileLabelHandler.config({P24TargetElementId:this.iframeContainer,P24CardWhiteLabelStartEventCallback:()=>{},P24NeedInteractionEventCallback:e=>{this.debug&&console.log("Need interaction:",e),this.onNeedInteraction(e)},P24DontNeedInteractionEventCallback:e=>{this.debug&&console.log("No interaction needed:",e),this.onNoNeedInteraction(e)},P24ScriptFailedEventCallback:e=>{this.debug&&console.log("Fail:",e),this.onFailed(e)},P24ScriptSuccessfulEndsEventCallback:e=>{this.debug&&console.log("Success:",e),this.onSuccess(e)}}),Przelewy24CardWhileLabelHandler.main(),this.runObserver()}runObserver(){const e=this.getIframeWrapper();e&&new MutationObserver((t=>{t.forEach((t=>{e.querySelector("iframe")}))})).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src"]})}async load(e){this.resetWhiteLabelIframe(),await h("card-whitelabel-script",`https://${this.mode}.przelewy24.pl/whitelabel/card/javascript/${e}`,(()=>{}),!0)}async onResponse(e){return console.log("[P24] onResponse input",e),new Promise(((t,s)=>{const{error:i,token:r,redirect:n}=e;this.promise.resolve=t,this.promise.reject=s,this.promise.redirect=n,i?t({error:i}):r&&(this.debug&&console.log("[P24] Transaction token:",r),this.load(r),n&&console.log("[P24] Redirect fallback:",n))}))}};window.wp.blocksCheckout;const{registerPaymentMethod:m}=window.wc.wcBlocksRegistry,{getSetting:u}=window.wc.wcSettings,{CheckboxControl:g}=window.wc.blocksCheckout,{useSelect:k}=window.wp.data,b=u("p24-card_data",{}),w=(0,e.decodeEntities)(b.title),y=b.i18n||{},v=new class extends d{constructor(e){super();const{config:t,mode:s="sandbox",lang:i="pl",clickToPay:r,recurring:n=!1,debug:o=!1}=e,{merchant_id:a,session_id:l,signature:c,options:d}=t;this.debug=o,this.tokenizerElement="card-tokenizer",this.merchantId=a,this.sessionId=l,this.signature=c,this.recurring=n,this.mode=s,this.clickToPay=r,this.whiteLabel=new p({...e}),this.tokenizer=null,this.error=null,this.cardData=null,this.oneClick=!1,this.saveOneClick=!1,this.prepareOptions(d,i)}prepareOptions(e,t){if("string"==typeof e)try{this.options=JSON.parse(e)}catch(e){this.options={}}else this.options=e;this.options.lang=t,this.options.loader=!0,this.options.errorMessage=!1,this.options.c2p=!1,this.options?.agreement||(this.agreement={contentEnabled:{enabled:!1,checkboxEnabled:!1}}),this.clickToPay?.enabled&&(this.options.c2p=!0,this.clickToPay?.email&&this.setClickToPayEmail(this.clickToPay.email))}setClickToPayEmail(e){this.options.c2p&&(this.options.psu={email:e})}setRecurring(e){this.recurring=e}setSaveOneClick(e){this.saveOneClick=e}setOneClick(e){this.oneClick=e||!1}async prepareData(){return this.error=null,this.cardData=null,!!this.oneClick||await this.tokenize()}async tokenize(){const e=this.saveOneClick||this.recurring?"permanent":"temporary";this.debug&&console.log("Tokenize mode",e);const t=await this.tokenizer.tokenize(e),{errors:s=[],data:i}=t?.data||{};if(s.length){const[e]=s;this.error=e}else i&&(this.cardData=i);return!!i}getError(){return this.error}loadTokenizer(){h("card-tokenizer-script",`https://${this.mode}.przelewy24.pl/js/cardTokenizationIframe.min.js?cms=woo&mid=${this.merchantId}&oc=${this.oneClick}&c2p=${this.options.c2p}`,(()=>this.onLoadTokenizer()))}onLoadTokenizer(){this.tokenizer=new Przelewy24CardTokenization(this.merchantId,this.sessionId,this.signature),this.renderTokenizer()}renderTokenizer(){this.tokenizer.render("form",`#${this.tokenizerElement}`,this.options)}reRenderTokenizer(){document.getElementById(this.tokenizerElement).innerHTML="",window.Przelewy24CardTokenization?this.onLoadTokenizer():this.loadTokenizer(),this.whiteLabel.init(),this.whiteLabel.runObserver()}getPaymentData(){let e="card-data";return this.oneClick&&(e="one-click"),{type:e,regulation:this.regulation,checkout:this.checkout,...Object.entries(this.cardData||{}).reduce(((e,[t,s])=>({...e,[t]:""+(s||"")})),{}),oneClick:!!this.oneClick&&this.oneClick.toString(),save:this.saveOneClick}}}(b),C=({onChange:e,options:t,value:s})=>t.length?(0,i.jsxs)("div",{className:"p24-1clicks",children:[(0,i.jsx)("div",{className:"p24-1clicks__label",children:y.use_saved}),(0,i.jsx)("div",{className:"p24-1clicks__items",children:t.map(((t,r)=>{let n="p24-1click p24-1click--card";return s===t.id&&(n+=" p24-1click--active"),(0,i.jsxs)("button",{className:n,type:"button",onClick:()=>{return i=t.id,void e(s===i?null:i);var i},children:[t?.logo&&(0,i.jsx)("figure",{className:"p24-1click__logo p24-1click--card__logo",children:(0,i.jsx)("img",{src:t.logo.url,alt:t.logo.alt})}),(0,i.jsxs)("span",{className:"p24-1click--card__number",children:[(0,i.jsx)("small",{children:"✱✱✱✱ ✱✱✱✱ ✱✱✱✱"})," ",t.last_digits]}),(0,i.jsx)("span",{className:"p24-1click--card__valid",children:t.valid_to})]},r)}))}),(0,i.jsx)("div",{className:"p24-1clicks__or",children:y.or})]}):null,f=({eventRegistration:e,emitResponse:s})=>{const[r,o]=function(){const[e,s]=(0,t.useState)(!1),[i,r]=(0,t.useState)(null);return(0,t.useEffect)((()=>{const e=e=>{const{data:t}=e;if(t?.p24&&"ready"===t?.type){if(console.log("[p24][event]",t),!1===t.status){s(!1);const e={invalidCardHolder:"Niepoprawne dane w formularzu kartowym: Imię i nazwisko",invalidExpirationDate:"Niepoprawne dane w formularzu kartowym: Data ważności karty",invalidCardNumber:"Niepoprawne dane w formularzu kartowym: Numer karty",invalidCVV:"Niepoprawne dane w formularzu kartowym: Kod CVV"},i=Array.isArray(t.error)?t.error[0]:null,n=i&&e[i]?e[i]:"Wystąpił problem z formularzem kartowym. Popraw błędy na formularzu, wybierz inną metodę płatności lub spróbuj ponownie.";console.warn("[p24][card error]",i,"=>",n),r(n)}!0===t.status&&(console.log("[p24][card valid] status OK"),s(!0),r(null))}};return window.addEventListener("message",e),()=>window.removeEventListener("message",e)}),[]),[e,i]}(),{responseTypes:a,noticeContexts:c}=s,{onPaymentSetup:d,onCheckoutSuccess:h,onCheckoutFail:p}=e,[m,u]=(0,t.useState)(!1),[w,f]=(0,t.useState)(!1),[x,E,j,z]=function(e,s){const[i,r]=(0,t.useState)(""),[n,o]=(0,t.useState)(!1),[a,l]=(0,t.useState)(!1),[c,d]=(0,t.useState)(!0);return(0,t.useEffect)((()=>{a&&r(c&&!n?s:"")}),[n,c,a]),[n,i,t=>{a||l(!0),e&&e.setRegulation(t),o(t)},(e=!0)=>{let t=!1;return e&&!n?(r(s),t=!1):(e&&n||!e)&&(r(""),t=!0),t},e=>{e||r(""),d(e)}]}(v,y.error.rules),S=b.clickToPay?.enabled?k((e=>e("wc/store/cart").getCustomerData()?.billingAddress?.email)):null,P=({errorMessage:e})=>(0,i.jsx)("div",{className:"wc-block-components-validation-input-error",children:(0,i.jsx)("p",{role:"alert",children:e})});return(0,t.useEffect)((()=>{b.clickToPay?.enabled&&(S&&v.setClickToPayEmail(S),document.addEventListener("change",(e=>{"email"===e.target.id&&(v.setClickToPayEmail(e.target.value),v.reRenderTokenizer())}))),v.loadTokenizer(),v.whiteLabel.init(),v.whiteLabel.runObserver()}),[]),(0,t.useEffect)((()=>{v.setSaveOneClick(m)}),[m]),(0,t.useEffect)((()=>{v.setOneClick(w),w&&u(!1)}),[w]),(0,t.useEffect)((()=>{const e=d((async()=>{const e={type:a.ERROR};return r?z()?(await v.prepareData(),v.hasError()?e.message=v.getError():(e.type=a.SUCCESS,e.meta={paymentMethodData:v.getPaymentData()}),e):e:(e.message=o||"Wystąpił problem z formularzem kartowym. Popraw błędy na formularzu, wybierz inną metodę płatności lub spróbuj ponownie.",e.messageContext=c.PAYMENTS,e)}));return()=>e()}),[a.ERROR,a.SUCCESS,d,w,m,x,E,r,o]),(0,t.useEffect)((()=>{const e=h((async({processingResponse:e})=>{const t=document.getElementById("p24-3ds-modal"),s=document.getElementById("p24-3ds-loader");t&&(t.classList.remove("hidden"),s&&s.classList.remove("hidden"));const i={type:a.ERROR},r=await v.whiteLabel.onResponse(e?.paymentDetails||{}),n=document.querySelector("#p24-3ds-iframe-wrapper iframe");return n&&n.addEventListener("load",(()=>{s&&s.classList.add("hidden")})),r.success&&r.redirect&&(i.type=a.SUCCESS,i.redirectUrl=r.redirect),r.error&&r.message&&(i.message=r.message,i.messageContext=c.PAYMENTS),i})),t=p((({processingResponse:e})=>{const{message:t}=e?.paymentDetails||{},s={type:a.ERROR};return t&&(s.message=t,s.messageContext=c.PAYMENTS),s}));return()=>{e(),t()}}),[a.ERROR,a.SUCCESS,h,p]),(0,i.jsxs)("div",{children:[(0,i.jsxs)("div",{className:"p24-payment-container",children:[b.description&&(0,i.jsx)(n,{description:b.description}),b.oneClick.enabled&&(0,i.jsx)(C,{value:w,onChange:f,options:b.oneClick.items}),(0,i.jsx)("div",{id:"card-tokenizer"}),o&&(0,i.jsx)(P,{errorMessage:o}),(0,i.jsx)("div",{id:"card-whitelabel"}),b.oneClick.enabled&&(0,i.jsx)("div",{className:"p24-checkbox",children:(0,i.jsx)(g,{disabled:!!w,label:y.label.save,checked:m,onChange:u})}),(0,i.jsxs)("div",{className:"p24-checkbox",children:[(0,i.jsx)(l,{required:!0,label:y.label.regulation,checked:x,onChange:j}),E?(0,i.jsx)(P,{errorMessage:E}):""]})]}),(0,i.jsx)("div",{id:"p24-3ds-modal",className:"p24-3ds-modal hidden fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center",children:(0,i.jsxs)("div",{className:"modal-content relative bg-white rounded shadow-lg p-4",children:[(0,i.jsx)("div",{id:"p24-3ds-loader",className:"absolute inset-0 flex items-center justify-center bg-white bg-opacity-80",children:(0,i.jsx)("div",{className:"loader border-4 border-blue-500 border-t-transparent rounded-full w-12 h-12 animate-spin"})}),(0,i.jsx)("div",{id:"p24-3ds-iframe-wrapper"})]})})]})};m({name:b.name,label:(0,i.jsx)(c,{label:w,icon:b.icon}),content:(0,i.jsx)(f,{}),edit:(0,i.jsx)(n,{description:b.description}),canMakePayment:()=>!0,ariaLabel:w,supports:{features:b.supports}})})();