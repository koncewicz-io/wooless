(()=>{"use strict";const e=window.React,t=window.wp.htmlEntities,{i18n:n,data:a}=window.wp,{__}=n,{CheckboxControl:s}=window.wc.blocksCheckout,r=e=>{const{description:n}=e;return(0,t.decodeEntities)(n||"")},o=t=>{let{src:n,name:a=""}=t.icon;return"string"==typeof t.icon&&(n=t.icon),(0,e.createElement)("img",{style:{maxHeight:"20px"},src:n,title:a,alt:a,loading:"lazy"})},i=t=>{const{icons:n,additional:a}=t;return n.length?(0,e.createElement)("span",{style:{display:"flex",flexWrap:"wrap",gap:"6px",fontSize:"65%",alignItems:"center",justifyContent:"flex-end"}},n.map((({src:t,name:n},a)=>(0,e.createElement)(o,{icon:{src:t,name:n},key:a}))),a?(0,e.createElement)("span",{style:{lineHeight:"1.2"}},__("+%d other methods","woocommerce-p24").replace("%d",a)):""):""},c=({required:t=!1,label:n,checked:a,onChange:r,...o})=>(0,e.createElement)(s,{required:t,label:(0,e.createElement)("span",{dangerouslySetInnerHTML:{__html:n}}),checked:a,onChange:r,...o,__nextHasNoMarginBottom:!0});class l{constructor(){this.reset(),this.debug=!1,this.regulation=!1,this.checkout="block"}setError(e){this.error=!0,this.errorMessage=e,this.debug&&console.log("Error:",e)}setCheckout(e){this.checkout=e}hasError(){return this.error}getError(){return this.errorMessage}reset(){this.error=!1,this.errorMessage=null}setRegulation(e){this.regulation=!!e}}class h extends l{constructor(){super(),this.paymentDetails={total:"0.00",currency:""},this.token=null,this.cancel=!1,this.paymentClient=null,this.paymentCanBeUsed=!1}reset(){super.reset(),this.cancel=!1,this.token=null}isCanceled(){return this.cancel}setCancel(e){this.cancel=e}setPaymentDetails(e,t){this.paymentDetails={total:parseFloat(e).toFixed(2).toString(),currency:t}}getPaymentData(){const{regulation:e}=this;return{payload:!!this.token&&btoa(this.token),regulation:e}}}const d=async(e,t,n=(()=>{}),a=!1)=>{let s=document.getElementById(e);if(s&&a&&(s.remove(),s=!1),!s){const a=document.createElement("script");return a.src=t,a.id=e,document.head.appendChild(a),await new Promise((e=>{a.addEventListener("load",(()=>e(n())))}))}return n(),!0},m=class{constructor(e){const{mode:t="sandbox",debug:n=!1}=e;this.iframeContainer="card-whitelabel",this.debug=n,this.mode=t,this.promise={reject:()=>{},resolve:()=>{},redirect:""}}init(){document.addEventListener("Przelewy24CardWhileLabelHandlerReady",(()=>this.whiteLabelHandler()),{once:!0})}getWhiteLabelElement(){return document.getElementById(this.iframeContainer)}resetWhiteLabelIframe(){const e=this.getWhiteLabelElement();e&&(e.innerHTML="")}onNeedInteraction(){}onNoNeedInteraction(){const{redirect:e,resolve:t}=this.promise;t({success:!0,redirect:e})}onFailed(e){const{resolve:t}=this.promise;t({error:e?.message||"Something goes wrong"})}onSuccess(){}whiteLabelHandler(){this.debug&&console.log("Run whitelabel event handler"),Przelewy24CardWhileLabelHandler.config({P24TargetElementId:this.iframeContainer,P24CardWhiteLabelStartEventCallback:e=>{this.debug&&(console.log("Start on merchant site"),console.log(e))},P24NeedInteractionEventCallback:e=>{this.debug&&(console.log("Need interaction on merchant site"),console.log(e)),this.onNeedInteraction(e)},P24DontNeedInteractionEventCallback:e=>{this.debug&&(console.log("Don't need interaction on merchant site"),console.log(e)),this.onNoNeedInteraction(e)},P24ScriptFailedEventCallback:e=>{this.debug&&(console.log("Fail!"),console.log(e)),this.onFailed(e)},P24ScriptSuccessfulEndsEventCallback:e=>{this.debug&&(console.log("Success!"),console.log(e)),this.onSuccess(e)}}),Przelewy24CardWhileLabelHandler.main()}runObserver(){const e=this.getWhiteLabelElement();e&&new MutationObserver(((t,n)=>{for(const n of t)if("childList"===n.type){const t=e.querySelector("iframe");t&&(window.location=t.src)}})).observe(e,{childList:!0})}getIframeUrl(){const e=this.getWhiteLabelElement().querySelector("iframe");return e?.src||null}async load(e){this.resetWhiteLabelIframe(),await d("card-whitelabel-script",`https://${this.mode}.przelewy24.pl/whitelabel/card/javascript/${e}`,(()=>{}),!0)}async onResponse(e){return new Promise(((t,n)=>{const{error:a,token:s,redirect:r}=e;this.promise.resolve=t,this.promise.reject=n,this.promise.redirect=r,a?t({error:a}):s&&(this.debug&&console.log("Transaction token",s),this.load(s))}))}},{registerPaymentMethod:u}=window.wc.wcBlocksRegistry,{getSetting:g}=window.wc.wcSettings,{ValidationInputError:p}=window.wc.blocksCheckout,y=g("p24-google-pay_data",{}),w=(0,t.decodeEntities)(y.title),b=y?.i18n||{},E=new class extends h{constructor(e){super();const{config:t,mode:n="sandbox",debug:a=!1}=e,{merchantId:s,googleMerchantId:r,merchantName:o}=t;this.debug=a,this.env="sandbox"===n?"TEST":"PRODUCTION",this.mode=n,this.whiteLabel=new m(e),this.merchantId=s,this.tokenizationParams={gateway:"przelewy24",gatewayMerchantId:"exampleGatewayMerchantId"},this.merchantInfo={merchantId:r,merchantName:o},"PRODUCTION"===this.env&&(this.tokenizationParams.gatewayMerchantId=this.merchantId)}async init(){await d("google-pay","https://pay.google.com/gp/p/js/pay.js",(()=>this.getClient()))}async canPayment(){if(this.paymentCanBeUsed)return!0;const e=this.getClient();if(!e)return!1;try{const{result:t=!1}=await e.isReadyToPay(this.getBasePaymentRequest());return this.paymentCanBeUsed=t,t}catch(e){return!1}}getClient(){return null===this.paymentClient&&window.google?.payments&&(this.paymentClient=new google.payments.api.PaymentsClient(this.getClientData())),this.paymentClient}getClientData(){const{merchantInfo:e,regulation:t}=this,n={environment:this.env,merchantInfo:e};return this.debug&&console.log("Client data:",n),n}getBasePaymentRequest(){const{tokenizationParams:e}=this,t={apiVersion:2,apiVersionMinor:0,allowedPaymentMethods:[{type:"CARD",tokenizationSpecification:{type:"PAYMENT_GATEWAY",parameters:e},parameters:{allowedAuthMethods:["PAN_ONLY","CRYPTOGRAM_3DS"],allowedCardNetworks:["AMEX","DISCOVER","JCB","MASTERCARD","VISA"]}}]};return this.debug&&console.log("Base payment data",t),t}getPaymentRequest(){const{merchantInfo:e,paymentDetails:t}=this,{total:n,currency:a}=t,s={...this.getBasePaymentRequest(),merchantInfo:e,transactionInfo:{currencyCode:a,totalPriceStatus:"FINAL",totalPrice:n}};return this.debug&&console.log("Payment data",s),s}async processPayment(){this.reset();let e=this.getClient();try{const t=await e.loadPaymentData(this.getPaymentRequest());this.token=t.paymentMethodData.tokenizationData.token,this.debug&&console.log("Result",this.token,t)}catch(e){"CANCELED"===e?.statusCode?this.setCancel(!0):this.setError(e?.statusMessage||e?.message||null)}}}(y);u({name:y.name,label:(0,e.createElement)((t=>{const{PaymentMethodLabel:n}=t.components,{label:a,icon:s,icons:r,additional:c}=t;return(0,e.createElement)("span",{style:{width:"100%",display:"flex",gap:"12px",justifyContent:"space-between",alignItems:"center"}},(0,e.createElement)(n,{text:a}),r?(0,e.createElement)(i,{icons:r,additional:c}):"",s?(0,e.createElement)(o,{icon:s}):"")}),{label:w,icon:y.icon}),content:(0,e.createElement)((({eventRegistration:t,emitResponse:n})=>{const{responseTypes:a,noticeContexts:s}=n,{onPaymentSetup:o,onCheckoutSuccess:i,onCheckoutFail:l}=t,[h,d,m,u]=function(t,n){const[a,s]=(0,e.useState)(""),[r,o]=(0,e.useState)(!1),[i,c]=(0,e.useState)(!1),[l,h]=(0,e.useState)(!0);return(0,e.useEffect)((()=>{i&&s(l&&!r?n:"")}),[r,l,i]),[r,a,e=>{i||c(!0),t&&t.setRegulation(e),o(e)},(e=!0)=>{let t=!1;return e&&!r?(s(n),t=!1):(e&&r||!e)&&(s(""),t=!0),t},e=>{e||s(""),h(e)}]}(E,b.error.rules);return(0,e.useEffect)((()=>{E.whiteLabel.init(),E.whiteLabel.runObserver()}),[]),(0,e.useEffect)((()=>{const e=o((async()=>{const e={type:a.ERROR};if(!u())return e;const t=(()=>{const{data:e}=window.wp,{CART_STORE_KEY:t}=window.wc.wcBlocksData,n=e.select(t).getCartTotals(),a=e.select(t).getCartData();return{total:Number(n.total_price)/100,currency:n.currency_code,country:a.billingAddress?.country||"PL"}})();return E.setPaymentDetails(t.total,t.currency),await E.processPayment(),E.hasError()||E.isCanceled()?e.message=E.getError():(e.type=a.SUCCESS,e.meta={paymentMethodData:E.getPaymentData()}),e}));return()=>{e()}}),[a.ERROR,a.SUCCESS,o,h,d]),(0,e.useEffect)((()=>{const e=i((async({processingResponse:e})=>{const t={type:a.ERROR},{success:n,error:r,redirect:o}=await E.whiteLabel.onResponse(e?.paymentDetails||{});return n&&o&&(t.type=a.SUCCESS,t.redirectUrl=o),r&&(t.message=r,t.messageContext=s.PAYMENTS),t})),t=l((({processingResponse:e})=>{const{message:t}=e?.paymentDetails||{},n={type:a.ERROR};return t&&(n.message=t,n.messageContext=s.PAYMENTS),n}));return()=>{e(),t()}}),[a.ERROR,a.SUCCESS,i,l]),(0,e.createElement)("div",{className:"p24-payment-container"},y.description&&(0,e.createElement)(r,{description:y.description}),(0,e.createElement)("div",{id:"card-whitelabel"}),(0,e.createElement)("div",{className:"p24-checkbox"},(0,e.createElement)(c,{required:!0,label:b.label.regulation,checked:h,onChange:m}),d?(0,e.createElement)(p,{errorMessage:d}):""))}),null),edit:(0,e.createElement)(r,{description:y.description}),canMakePayment:async()=>(await E.init(),await E.canPayment()),ariaLabel:w,placeOrderButtonLabel:b.label.submit,supports:{features:y.supports}})})();