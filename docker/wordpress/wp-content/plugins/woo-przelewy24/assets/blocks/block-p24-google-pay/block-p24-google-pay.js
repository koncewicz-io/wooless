(()=>{"use strict";const e=window.wp.htmlEntities,t=window.React,n=window.wp.i18n,s=window.ReactJSXRuntime,{CheckboxControl:a}=window.wc.blocksCheckout,r=t=>{const{description:n}=t;return(0,e.decodeEntities)(n||"")},o=e=>{let{src:t,name:n=""}=e.icon;return"string"==typeof e.icon&&(t=e.icon),(0,s.jsx)("img",{style:{maxHeight:"20px"},src:t,title:n,alt:n,loading:"lazy"})},i=e=>{const{icons:t,additional:a}=e;return t.length?(0,s.jsxs)("span",{style:{display:"flex",flexWrap:"wrap",gap:"6px",fontSize:"65%",alignItems:"center",justifyContent:"flex-end"},children:[t.map((({src:e,name:t},n)=>(0,s.jsx)(o,{icon:{src:e,name:t}},n))),a?(0,s.jsx)("span",{style:{lineHeight:"1.2"},children:(0,n.sprintf)((0,n.__)("+%d other methods","woocommerce-p24"),a)}):""]}):""},c=({required:e=!1,label:t,checked:n,onChange:r,...o})=>(0,s.jsx)(a,{required:e,label:(0,s.jsx)("span",{dangerouslySetInnerHTML:{__html:t}}),checked:n,onChange:r,...o,__nextHasNoMarginBottom:!0}),l=e=>{const{PaymentMethodLabel:t}=e.components,{label:n,icon:a,icons:r,additional:c}=e;return(0,s.jsxs)("span",{style:{width:"100%",display:"flex",gap:"12px",justifyContent:"space-between",alignItems:"center"},children:[(0,s.jsx)(t,{text:n}),r?(0,s.jsx)(i,{icons:r,additional:c}):"",a?(0,s.jsx)(o,{icon:a}):""]})};class d{constructor(){this.reset(),this.debug=!1,this.regulation=!1,this.checkout="block"}setError(e){this.error=!0,this.errorMessage=e,this.debug&&console.log("Error:",e)}setCheckout(e){this.checkout=e}hasError(){return this.error}getError(){return this.errorMessage}reset(){this.error=!1,this.errorMessage=null}setRegulation(e){this.regulation=!!e}}class h extends d{constructor(){super(),this.paymentDetails={total:"0.00",currency:""},this.token=null,this.cancel=!1,this.paymentClient=null,this.paymentCanBeUsed=!1}reset(){super.reset(),this.cancel=!1,this.token=null}isCanceled(){return this.cancel}setCancel(e){this.cancel=e}setPaymentDetails(e,t){this.paymentDetails={total:parseFloat(e).toFixed(2).toString(),currency:t}}getPaymentData(){const{regulation:e}=this;return{payload:!!this.token&&btoa(this.token),regulation:e}}}const u=async(e,t,n=()=>{},s=!1)=>{let a=document.getElementById(e);if(a&&s&&(a.remove(),a=!1),!a){const s=document.createElement("script");return s.src=t,s.id=e,document.head.appendChild(s),await new Promise((e=>{s.addEventListener("load",(()=>e(n())))}))}return n(),!0},m=class{constructor(e){const{mode:t="sandbox",debug:n=!1}=e;this.iframeContainer="p24-3ds-iframe-wrapper",this.modalId="p24-3ds-modal",this.debug=n,this.mode=t,this.promise={reject:()=>{},resolve:()=>{},redirect:""}}init(){document.addEventListener("Przelewy24CardWhileLabelHandlerReady",(()=>this.whiteLabelHandler()),{once:!0})}getIframeWrapper(){return document.getElementById(this.iframeContainer)}getModal(){return document.getElementById(this.modalId)}openModal(){const e=this.getModal();e&&e.classList.add("active")}closeModal(){const e=this.getModal();e&&e.classList.remove("active")}resetWhiteLabelIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}onNeedInteraction(){this.debug&&console.log("[P24] Need interaction — showing modal"),this.openModal()}onNoNeedInteraction(){this.debug&&console.log("[P24] No interaction — handled by runObserver")}onFailed(e){this.debug&&console.log("[P24] Payment failed"),this.removeIframe(),this.closeModal();const{resolve:t}=this.promise;t({error:e?.message||"Something goes wrong"})}onSuccess(){this.closeModal(),this.removeIframe(),this.promise?.redirect?window.location.href=this.promise.redirect:console.warn("[P24] No redirect URL available")}removeIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}whiteLabelHandler(){Przelewy24CardWhileLabelHandler.config({P24TargetElementId:this.iframeContainer,P24CardWhiteLabelStartEventCallback:()=>{},P24NeedInteractionEventCallback:e=>{this.debug&&console.log("Need interaction:",e),this.onNeedInteraction(e)},P24DontNeedInteractionEventCallback:e=>{this.debug&&console.log("No interaction needed:",e),this.onNoNeedInteraction(e)},P24ScriptFailedEventCallback:e=>{this.debug&&console.log("Fail:",e),this.onFailed(e)},P24ScriptSuccessfulEndsEventCallback:e=>{this.debug&&console.log("Success:",e),this.onSuccess(e)}}),Przelewy24CardWhileLabelHandler.main(),this.runObserver()}runObserver(){const e=this.getIframeWrapper();e&&new MutationObserver((t=>{t.forEach((t=>{e.querySelector("iframe")}))})).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src"]})}async load(e){this.resetWhiteLabelIframe(),await u("card-whitelabel-script",`https://${this.mode}.przelewy24.pl/whitelabel/card/javascript/${e}`,(()=>{}),!0)}async onResponse(e){return console.log("[P24] onResponse input",e),new Promise(((t,n)=>{const{error:s,token:a,redirect:r}=e;this.promise.resolve=t,this.promise.reject=n,this.promise.redirect=r,s?t({error:s}):a&&(this.debug&&console.log("[P24] Transaction token:",a),this.load(a),r&&console.log("[P24] Redirect fallback:",r))}))}},{registerPaymentMethod:g}=window.wc.wcBlocksRegistry,{getSetting:p}=window.wc.wcSettings,{ValidationInputError:y}=window.wc.blocksCheckout,w=p("p24-google-pay_data",{}),b=(0,e.decodeEntities)(w.title),C=w?.i18n||{},P=new class extends h{constructor(e){super();const{config:t,mode:n="sandbox",debug:s=!1}=e,{merchantId:a,googleMerchantId:r,merchantName:o}=t;this.debug=s,this.env="sandbox"===n?"TEST":"PRODUCTION",this.mode=n,this.whiteLabel=new m(e),this.merchantId=a,this.tokenizationParams={gateway:"przelewy24",gatewayMerchantId:"exampleGatewayMerchantId"},this.merchantInfo={merchantId:r,merchantName:o},"PRODUCTION"===this.env&&(this.tokenizationParams.gatewayMerchantId=this.merchantId)}async init(){await u("google-pay","https://pay.google.com/gp/p/js/pay.js",(()=>this.getClient()))}async canPayment(){if(this.paymentCanBeUsed)return!0;const e=this.getClient();if(!e)return!1;try{const{result:t=!1}=await e.isReadyToPay(this.getBasePaymentRequest());return this.paymentCanBeUsed=t,t}catch(e){return!1}}getClient(){return null===this.paymentClient&&window.google?.payments&&(this.paymentClient=new google.payments.api.PaymentsClient(this.getClientData())),this.paymentClient}getClientData(){const{merchantInfo:e,regulation:t}=this,n={environment:this.env,merchantInfo:e};return this.debug&&console.log("Client data:",n),n}getBasePaymentRequest(){const{tokenizationParams:e}=this,t={apiVersion:2,apiVersionMinor:0,allowedPaymentMethods:[{type:"CARD",tokenizationSpecification:{type:"PAYMENT_GATEWAY",parameters:e},parameters:{allowedAuthMethods:["PAN_ONLY","CRYPTOGRAM_3DS"],allowedCardNetworks:["AMEX","DISCOVER","JCB","MASTERCARD","VISA"]}}]};return this.debug&&console.log("Base payment data",t),t}getPaymentRequest(){const{merchantInfo:e,paymentDetails:t}=this,{total:n,currency:s}=t,a={...this.getBasePaymentRequest(),merchantInfo:e,transactionInfo:{currencyCode:s,totalPriceStatus:"FINAL",totalPrice:n}};return this.debug&&console.log("Payment data",a),a}async processPayment(){this.reset();let e=this.getClient();try{const t=await e.loadPaymentData(this.getPaymentRequest());this.token=t.paymentMethodData.tokenizationData.token,this.debug&&console.log("Result",this.token,t)}catch(e){"CANCELED"===e?.statusCode?this.setCancel(!0):this.setError(e?.statusMessage||e?.message||null)}}}(w),f=({eventRegistration:e,emitResponse:n})=>{const{responseTypes:a,noticeContexts:o}=n,{onPaymentSetup:i,onCheckoutSuccess:l,onCheckoutFail:d}=e,[h,u,m,g]=function(e,n){const[s,a]=(0,t.useState)(""),[r,o]=(0,t.useState)(!1),[i,c]=(0,t.useState)(!1),[l,d]=(0,t.useState)(!0);return(0,t.useEffect)((()=>{i&&a(l&&!r?n:"")}),[r,l,i]),[r,s,t=>{i||c(!0),e&&e.setRegulation(t),o(t)},(e=!0)=>{let t=!1;return e&&!r?(a(n),t=!1):(e&&r||!e)&&(a(""),t=!0),t},e=>{e||a(""),d(e)}]}(P,C.error.rules);return(0,t.useEffect)((()=>{P.whiteLabel.init(),P.whiteLabel.runObserver()}),[]),(0,t.useEffect)((()=>{const e=i((async()=>{const e={type:a.ERROR};if(!g())return e;const t=(()=>{const{data:e}=window.wp,{CART_STORE_KEY:t}=window.wc.wcBlocksData,n=e.select(t).getCartTotals(),s=e.select(t).getCartData();return{total:Number(n.total_price)/100,currency:n.currency_code,country:s.billingAddress?.country||"PL"}})();return P.setPaymentDetails(t.total,t.currency),await P.processPayment(),P.hasError()||P.isCanceled()?e.message=P.getError():(e.type=a.SUCCESS,e.meta={paymentMethodData:P.getPaymentData()}),e}));return()=>{e()}}),[a.ERROR,a.SUCCESS,i,h,u]),(0,t.useEffect)((()=>{const e=l((async({processingResponse:e})=>{const t={type:a.ERROR},{success:n,error:s,redirect:r}=await P.whiteLabel.onResponse(e?.paymentDetails||{});return n&&r&&(t.type=a.SUCCESS,t.redirectUrl=r),s&&(t.message=s,t.messageContext=o.PAYMENTS),t})),t=d((({processingResponse:e})=>{const{message:t}=e?.paymentDetails||{},n={type:a.ERROR};return t&&(n.message=t,n.messageContext=o.PAYMENTS),n}));return()=>{e(),t()}}),[a.ERROR,a.SUCCESS,l,d]),(0,s.jsxs)("div",{className:"p24-payment-container",children:[w.description&&(0,s.jsx)(r,{description:w.description}),(0,s.jsx)("div",{id:"card-whitelabel"}),(0,s.jsxs)("div",{className:"p24-checkbox",children:[(0,s.jsx)(c,{required:!0,label:C.label.regulation,checked:h,onChange:m}),u?(0,s.jsx)(y,{errorMessage:u}):""]})]})};g({name:w.name,label:(0,s.jsx)(l,{label:b,icon:w.icon}),content:(0,s.jsx)(f,{}),edit:(0,s.jsx)(r,{description:w.description}),canMakePayment:async()=>(await P.init(),await P.canPayment()),ariaLabel:b,placeOrderButtonLabel:C.label.submit,supports:{features:w.supports}})})();