(()=>{"use strict";const e=window.wp.htmlEntities,t=window.React,s=window.wp.i18n,n=window.ReactJSXRuntime,{CheckboxControl:a}=window.wc.blocksCheckout,r=t=>{const{description:s}=t;return(0,e.decodeEntities)(s||"")},i=e=>{let{src:t,name:s=""}=e.icon;return"string"==typeof e.icon&&(t=e.icon),(0,n.jsx)("img",{style:{maxHeight:"20px"},src:t,title:s,alt:s,loading:"lazy"})},o=e=>{const{icons:t,additional:a}=e;return t.length?(0,n.jsxs)("span",{style:{display:"flex",flexWrap:"wrap",gap:"6px",fontSize:"65%",alignItems:"center",justifyContent:"flex-end"},children:[t.map((({src:e,name:t},s)=>(0,n.jsx)(i,{icon:{src:e,name:t}},s))),a?(0,n.jsx)("span",{style:{lineHeight:"1.2"},children:(0,s.sprintf)((0,s.__)("+%d other methods","woocommerce-p24"),a)}):""]}):""},c=({required:e=!1,label:t,checked:s,onChange:r,...i})=>(0,n.jsx)(a,{required:e,label:(0,n.jsx)("span",{dangerouslySetInnerHTML:{__html:t}}),checked:s,onChange:r,...i,__nextHasNoMarginBottom:!0}),l=e=>{const{PaymentMethodLabel:t}=e.components,{label:s,icon:a,icons:r,additional:c}=e;return(0,n.jsxs)("span",{style:{width:"100%",display:"flex",gap:"12px",justifyContent:"space-between",alignItems:"center"},children:[(0,n.jsx)(t,{text:s}),r?(0,n.jsx)(o,{icons:r,additional:c}):"",a?(0,n.jsx)(i,{icon:a}):""]})};class d{constructor(){this.reset(),this.debug=!1,this.regulation=!1,this.checkout="block"}setError(e){this.error=!0,this.errorMessage=e,this.debug&&console.log("Error:",e)}setCheckout(e){this.checkout=e}hasError(){return this.error}getError(){return this.errorMessage}reset(){this.error=!1,this.errorMessage=null}setRegulation(e){this.regulation=!!e}}class h extends d{constructor(){super(),this.paymentDetails={total:"0.00",currency:""},this.token=null,this.cancel=!1,this.paymentClient=null,this.paymentCanBeUsed=!1}reset(){super.reset(),this.cancel=!1,this.token=null}isCanceled(){return this.cancel}setCancel(e){this.cancel=e}setPaymentDetails(e,t){this.paymentDetails={total:parseFloat(e).toFixed(2).toString(),currency:t}}getPaymentData(){const{regulation:e}=this;return{payload:!!this.token&&btoa(this.token),regulation:e}}}const u=async(e,t,s=()=>{},n=!1)=>{let a=document.getElementById(e);if(a&&n&&(a.remove(),a=!1),!a){const n=document.createElement("script");return n.src=t,n.id=e,document.head.appendChild(n),await new Promise((e=>{n.addEventListener("load",(()=>e(s())))}))}return s(),!0},p=class{constructor(e){const{mode:t="sandbox",debug:s=!1}=e;this.iframeContainer="p24-3ds-iframe-wrapper",this.modalId="p24-3ds-modal",this.debug=s,this.mode=t,this.promise={reject:()=>{},resolve:()=>{},redirect:""}}init(){document.addEventListener("Przelewy24CardWhileLabelHandlerReady",(()=>this.whiteLabelHandler()),{once:!0})}getIframeWrapper(){return document.getElementById(this.iframeContainer)}getModal(){return document.getElementById(this.modalId)}openModal(){const e=this.getModal();e&&e.classList.add("active")}closeModal(){const e=this.getModal();e&&e.classList.remove("active")}resetWhiteLabelIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}onNeedInteraction(){this.debug&&console.log("[P24] Need interaction — showing modal"),this.openModal()}onNoNeedInteraction(){this.debug&&console.log("[P24] No interaction — handled by runObserver")}onFailed(e){this.debug&&console.log("[P24] Payment failed"),this.removeIframe(),this.closeModal();const{resolve:t}=this.promise;t({error:e?.message||"Something goes wrong"})}onSuccess(){this.closeModal(),this.removeIframe(),this.promise?.redirect?window.location.href=this.promise.redirect:console.warn("[P24] No redirect URL available")}removeIframe(){const e=this.getIframeWrapper();e&&(e.innerHTML="")}whiteLabelHandler(){Przelewy24CardWhileLabelHandler.config({P24TargetElementId:this.iframeContainer,P24CardWhiteLabelStartEventCallback:()=>{},P24NeedInteractionEventCallback:e=>{this.debug&&console.log("Need interaction:",e),this.onNeedInteraction(e)},P24DontNeedInteractionEventCallback:e=>{this.debug&&console.log("No interaction needed:",e),this.onNoNeedInteraction(e)},P24ScriptFailedEventCallback:e=>{this.debug&&console.log("Fail:",e),this.onFailed(e)},P24ScriptSuccessfulEndsEventCallback:e=>{this.debug&&console.log("Success:",e),this.onSuccess(e)}}),Przelewy24CardWhileLabelHandler.main(),this.runObserver()}runObserver(){const e=this.getIframeWrapper();e&&new MutationObserver((t=>{t.forEach((t=>{e.querySelector("iframe")}))})).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["src"]})}async load(e){this.resetWhiteLabelIframe(),await u("card-whitelabel-script",`https://${this.mode}.przelewy24.pl/whitelabel/card/javascript/${e}`,(()=>{}),!0)}async onResponse(e){return console.log("[P24] onResponse input",e),new Promise(((t,s)=>{const{error:n,token:a,redirect:r}=e;this.promise.resolve=t,this.promise.reject=s,this.promise.redirect=r,n?t({error:n}):a&&(this.debug&&console.log("[P24] Transaction token:",a),this.load(a),r&&console.log("[P24] Redirect fallback:",r))}))}},{registerPaymentMethod:m}=window.wc.wcBlocksRegistry,{getSetting:y}=window.wc.wcSettings,{ValidationInputError:g}=window.wc.blocksCheckout,w=y("p24-apple-pay_data",{}),b=(0,e.decodeEntities)(w.title),C=w.i18n||{},S=new class extends h{constructor(e){super();const{config:t,mode:s="sandbox",debug:n=!1}=e,{appleMerchantId:a,merchantName:r,countryCode:i="PL",url:o}=t;this.debug=n,this.session=null,this.validateUrl=o,this.whiteLabel=new p(e),this.merchantId=a,this.merchantName=r,this.countryCode=i}async init(){await u("apple-pay","https://applepay.cdn-apple.com/jsapi/1.latest/apple-pay-sdk.js",(()=>this.getClient()))}async canPayment(){if(this.paymentCanBeUsed)return!0;const e=this.getClient();if(!e)return!1;try{const t=await e.canMakePayments();return this.paymentCanBeUsed=t,t}catch(e){return!1}}setCountryCode(e){this.countryCode=e}getClient(){return null===this.paymentClient&&window.ApplePaySession&&(this.paymentClient=window.ApplePaySession),this.paymentClient}getPaymentRequest(){const{merchantName:e,countryCode:t,paymentDetails:s}=this,{total:n,currency:a}=s,r={countryCode:t,currencyCode:a,merchantCapabilities:["supports3DS","supportsCredit","supportsDebit"],supportedNetworks:["visa","masterCard","amex","discover"],total:{label:e,type:"final",amount:n}};return this.debug&&console.log("Base payment data",r),r}addListenersToSession(){this.session.onvalidatemerchant=e=>{this.validateMerchant()},this.session.onpaymentauthorized=e=>{this.token=e.payment.token,this.debug&&console.log("Result",this.token,e),this.resolve(!0)},this.session.oncancel=e=>{this.reject("CANCELED")}}complete(e){const t={status:e?ApplePaySession.STATUS_SUCCESS:ApplePaySession.STATUS_FAILURE};this.session.completePayment(t)}async validateMerchant(){try{let e=await fetch(this.validateUrl);const t=await e.json();t&&this.session.completeMerchantValidation(t)}catch(e){this.reject(e)}}async processPayment(e,t){this.reset();let s=this.getClient();try{await new Promise((async(e,t)=>{this.session=new s(14,this.getPaymentRequest()),this.reject=t,this.resolve=e,this.addListenersToSession(),this.session.begin()}))}catch(e){"CANCELED"===e?this.setCancel(!0):this.setError(e||null)}}}(w),E=({eventRegistration:e,emitResponse:s})=>{const{responseTypes:a,noticeContexts:i}=s,{onPaymentSetup:o,onCheckoutSuccess:l,onCheckoutFail:d}=e,[h,u,p,m]=function(e,s){const[n,a]=(0,t.useState)(""),[r,i]=(0,t.useState)(!1),[o,c]=(0,t.useState)(!1),[l,d]=(0,t.useState)(!0);return(0,t.useEffect)((()=>{o&&a(l&&!r?s:"")}),[r,l,o]),[r,n,t=>{o||c(!0),e&&e.setRegulation(t),i(t)},(e=!0)=>{let t=!1;return e&&!r?(a(s),t=!1):(e&&r||!e)&&(a(""),t=!0),t},e=>{e||a(""),d(e)}]}(S,C.error.rules);return(0,t.useEffect)((()=>{S.whiteLabel.init(),S.whiteLabel.runObserver()}),[]),(0,t.useEffect)((()=>{const e=o((async()=>{const e={type:a.ERROR};if(!m())return e;const t=(()=>{const{data:e}=window.wp,{CART_STORE_KEY:t}=window.wc.wcBlocksData,s=e.select(t).getCartTotals(),n=e.select(t).getCartData();return{total:Number(s.total_price)/100,currency:s.currency_code,country:n.billingAddress?.country||"PL"}})();return S.setPaymentDetails(t.total,t.currency),S.setCountryCode(t.country),await S.processPayment(),S.hasError()||S.isCanceled()?e.message=S.getError():(e.type=a.SUCCESS,e.meta={paymentMethodData:S.getPaymentData()}),e}));return()=>{e()}}),[a.ERROR,a.SUCCESS,o,h,u]),(0,t.useEffect)((()=>{const e=l((async({processingResponse:e})=>{const t={type:a.ERROR};S.complete(response.success);const{success:s,error:n,redirect:r}=await S.whiteLabel.onResponse(e?.paymentDetails||{});return s&&r&&(t.redirectUrl=r,t.type=a.SUCCESS),n&&(t.message=n,t.messageContext=i.PAYMENTS),t})),t=d((({processingResponse:e})=>{const{message:t}=e?.paymentDetails||{},s={type:a.ERROR};return t&&(s.message=t,s.messageContext=i.PAYMENTS),s}));return()=>{e(),t()}}),[a.ERROR,a.SUCCESS,l,d]),(0,n.jsxs)("div",{className:"p24-payment-container",children:[w.description&&(0,n.jsx)(r,{description:w.description}),(0,n.jsx)("div",{id:"card-whitelabel"}),(0,n.jsxs)("div",{className:"p24-checkbox",children:[(0,n.jsx)(c,{required:!0,label:C.label.regulation,checked:h,onChange:p}),u?(0,n.jsx)(g,{errorMessage:u}):""]})]})};m({name:w.name,label:(0,n.jsx)(l,{label:b,icon:w.icon}),content:(0,n.jsx)(E,{}),edit:(0,n.jsx)(r,{}),canMakePayment:async()=>(await S.init(),await S.canPayment()),ariaLabel:b,placeOrderButtonLabel:C.label.submit,supports:{features:w.supports}})})();