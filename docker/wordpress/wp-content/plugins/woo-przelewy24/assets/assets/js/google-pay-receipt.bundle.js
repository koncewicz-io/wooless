!function(){"use strict";class e{constructor(){this.reset(),this.debug=!1,this.regulation=!1,this.checkout="block"}setError(e){this.error=!0,this.errorMessage=e,this.debug&&console.log("Error:",e)}setCheckout(e){this.checkout=e}hasError(){return this.error}getError(){return this.errorMessage}reset(){this.error=!1,this.errorMessage=null}setRegulation(e){this.regulation=!!e}}class t extends e{constructor(){super(),this.paymentDetails={total:"0.00",currency:""},this.token=null,this.cancel=!1,this.paymentClient=null,this.paymentCanBeUsed=!1}reset(){super.reset(),this.cancel=!1,this.token=null}isCanceled(){return this.cancel}setCancel(e){this.cancel=e}setPaymentDetails(e,t){this.paymentDetails={total:parseFloat(e).toFixed(2).toString(),currency:t}}getPaymentData(){const{regulation:e}=this;return{payload:!!this.token&&btoa(this.token),regulation:e}}}const s=async(e,t,s=(()=>{}),n=!1)=>{let i=document.getElementById(e);if(i&&n&&(i.remove(),i=!1),!i){const n=document.createElement("script");return n.src=t,n.id=e,document.head.appendChild(n),await new Promise((e=>{n.addEventListener("load",(()=>e(s())))}))}return s(),!0};class n{constructor(e){const{mode:t="sandbox",debug:s=!1}=e;this.iframeContainer="card-whitelabel",this.debug=s,this.mode=t,this.promise={reject:()=>{},resolve:()=>{},redirect:""}}init(){document.addEventListener("Przelewy24CardWhileLabelHandlerReady",(()=>this.whiteLabelHandler()),{once:!0})}getWhiteLabelElement(){return document.getElementById(this.iframeContainer)}resetWhiteLabelIframe(){const e=this.getWhiteLabelElement();e&&(e.innerHTML="")}onNeedInteraction(){}onNoNeedInteraction(){const{redirect:e,resolve:t}=this.promise;t({success:!0,redirect:e})}onFailed(e){const{resolve:t}=this.promise;t({error:e?.message||"Something goes wrong"})}onSuccess(){}whiteLabelHandler(){this.debug&&console.log("Run whitelabel event handler"),Przelewy24CardWhileLabelHandler.config({P24TargetElementId:this.iframeContainer,P24CardWhiteLabelStartEventCallback:e=>{this.debug&&(console.log("Start on merchant site"),console.log(e))},P24NeedInteractionEventCallback:e=>{this.debug&&(console.log("Need interaction on merchant site"),console.log(e)),this.onNeedInteraction(e)},P24DontNeedInteractionEventCallback:e=>{this.debug&&(console.log("Don't need interaction on merchant site"),console.log(e)),this.onNoNeedInteraction(e)},P24ScriptFailedEventCallback:e=>{this.debug&&(console.log("Fail!"),console.log(e)),this.onFailed(e)},P24ScriptSuccessfulEndsEventCallback:e=>{this.debug&&(console.log("Success!"),console.log(e)),this.onSuccess(e)}}),Przelewy24CardWhileLabelHandler.main()}runObserver(){const e=this.getWhiteLabelElement();if(!e)return;new MutationObserver(((t,s)=>{for(const s of t)if("childList"===s.type){const t=e.querySelector("iframe");t&&(window.location=t.src)}})).observe(e,{childList:!0})}getIframeUrl(){const e=this.getWhiteLabelElement().querySelector("iframe");return e?.src||null}async load(e){this.resetWhiteLabelIframe(),await s("card-whitelabel-script",`https://${this.mode}.przelewy24.pl/whitelabel/card/javascript/${e}`,(()=>{}),!0)}async onResponse(e){return new Promise(((t,s)=>{const{error:n,token:i,redirect:a}=e;this.promise.resolve=t,this.promise.reject=s,this.promise.redirect=a,n?t({error:n}):i&&(this.debug&&console.log("Transaction token",i),this.load(i))}))}}class i extends t{constructor(e){super();const{config:t,mode:s="sandbox",debug:i=!1}=e,{merchantId:a,googleMerchantId:r,merchantName:o}=t;this.debug=i,this.env="sandbox"===s?"TEST":"PRODUCTION",this.mode=s,this.whiteLabel=new n(e),this.merchantId=a,this.tokenizationParams={gateway:"przelewy24",gatewayMerchantId:"exampleGatewayMerchantId"},this.merchantInfo={merchantId:r,merchantName:o},"PRODUCTION"===this.env&&(this.tokenizationParams.gatewayMerchantId=this.merchantId)}async init(){await s("google-pay","https://pay.google.com/gp/p/js/pay.js",(()=>this.getClient()))}async canPayment(){if(this.paymentCanBeUsed)return!0;const e=this.getClient();if(!e)return!1;try{const{result:t=!1}=await e.isReadyToPay(this.getBasePaymentRequest());return this.paymentCanBeUsed=t,t}catch(e){return!1}}getClient(){return null===this.paymentClient&&window.google?.payments&&(this.paymentClient=new google.payments.api.PaymentsClient(this.getClientData())),this.paymentClient}getClientData(){const{merchantInfo:e,regulation:t}=this,s={environment:this.env,merchantInfo:e};return this.debug&&console.log("Client data:",s),s}getBasePaymentRequest(){const{tokenizationParams:e}=this,t={apiVersion:2,apiVersionMinor:0,allowedPaymentMethods:[{type:"CARD",tokenizationSpecification:{type:"PAYMENT_GATEWAY",parameters:e},parameters:{allowedAuthMethods:["PAN_ONLY","CRYPTOGRAM_3DS"],allowedCardNetworks:["AMEX","DISCOVER","JCB","MASTERCARD","VISA"]}}]};return this.debug&&console.log("Base payment data",t),t}getPaymentRequest(){const{merchantInfo:e,paymentDetails:t}=this,{total:s,currency:n}=t,i={...this.getBasePaymentRequest(),merchantInfo:e,transactionInfo:{currencyCode:n,totalPriceStatus:"FINAL",totalPrice:s}};return this.debug&&console.log("Payment data",i),i}async processPayment(){this.reset();let e=this.getClient();try{const t=await e.loadPaymentData(this.getPaymentRequest());this.token=t.paymentMethodData.tokenizationData.token,this.debug&&console.log("Result",this.token,t)}catch(e){"CANCELED"===e?.statusCode?this.setCancel(!0):this.setError(e?.statusMessage||e?.message||null)}}}class a{constructor(e){this.parent=e,this.notice=document.createElement("div"),this.notice.classList.add("wc-block-components-notice-banner"),this.notice.classList.add("is-error")}show(e){e&&(e="object"==typeof e?e?.message:e,this.notice.innerHTML=e,this.parent.prepend(this.notice))}hide(){this.notice.remove()}}class r{constructor(){this.selectors={form:document.querySelector("form.p24-payment-container"),submitButton:document.getElementById("submit"),regulation:document.getElementById("regulation")},this.config=window._config,this.service=null,this.notice=new a(this.selectors.form),this.submitHandler(),this.regulationHandlers()}regulationHandlers(){const{regulation:e}=this.selectors;e&&e.addEventListener("change",(()=>{this.service.setRegulation(e.checked)}))}submitHandler(){const{form:e}=this.selectors;e.addEventListener("submit",(e=>{e.preventDefault(),this.notice.hide(),this.submit()}))}async submit(){}async submitData(){const e={type:"register-transaction",orderId:this.config.orderId,orderKey:this.config.orderKey,checkout:this.service.checkout,paymentDetails:this.service.getPaymentData()};let t=await fetch(this.config.url,{method:"POST",body:JSON.stringify(e)});const{data:s}=await t.json()||{data:{}};return s}}class o extends r{async canPayment(){const{submitButton:e}=this.selectors;this.enabled=await this.service.canPayment(),this.enabled?e.disabled=!1:this.notice.show(_config.i18n.error.unavailable)}async submit(){const{submitButton:e}=this.selectors;e.disabled=!0;try{const{total:t,currency:s}=_config.paymentDetails;if(this.service.setPaymentDetails(t,s),await this.service.processPayment(),this.service.hasError())throw new Error(this.service.getError());if(this.service.isCanceled())return void(e.disabled=!1);const n={type:"register-transaction",orderId:_config.orderId,orderKey:_config.orderKey,paymentDetails:this.service.getPaymentData()},{success:i,error:a,message:r,token:o}=await this.submitData(n);if(a&&r)throw new Error(r);i&&o&&await this.service.whiteLabel.load(o)}catch(e){this.notice.show(e)}e.disabled=!1}}class c extends o{constructor(){super(),this.service=new i(_config),this.service.setCheckout("legacy"),this.init()}async init(){await this.service.init(),await this.canPayment(),this.service.whiteLabel.init(),this.service.whiteLabel.runObserver()}}window.addEventListener("DOMContentLoaded",(()=>{window.p24GooglePayReceipt=new c}))}();
